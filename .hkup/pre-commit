#!/bin/bash

# Define the gofumpt formatter command
GOFUMPT_CMD="gofumpt"

# --- Define the file list generator command ---
# Uses -z to delimit output with NULL characters for safe handling of filenames
# Storing this in a variable makes the script cleaner.
STAGED_GO_FILES_CMD="git diff --cached --name-only --diff-filter=ACMR -z -- '*.go'"

# 1. Check if any staged Go files exist
# This runs the command once to check for output.
if ! eval "$STAGED_GO_FILES_CMD" | grep -q . ; then
    echo "No staged Go files to format. Skipping gofumpt."
    exit 0
fi

echo "---"
echo "Running gofumpt on staged Go files..."
echo "---"

# 2. Run gofumpt on the files
# Pipe the NULL-delimited file list DIRECTLY into xargs -0.
# The -w flag writes the changes back to the working copy.
eval "$STAGED_GO_FILES_CMD" | xargs -0 -r "$GOFUMPT_CMD" -w

# Check gofumpt's exit code
GOFUMPT_EXIT_CODE=$?
if [ $GOFUMPT_EXIT_CODE -ne 0 ]; then
    echo "---"
    echo "gofumpt failed (likely a syntax error). Commit aborted."
    echo "---"
    exit 1
fi

# 3. Re-stage any files that gofumpt modified
echo "---"
echo "Re-staging formatted files..."
echo "---"

# Pipe the NULL-delimited file list DIRECTLY into xargs -0 to re-stage them.
eval "$STAGED_GO_FILES_CMD" | xargs -0 -r git add -u

# Final success message and exit
echo "gofumpt formatting complete and changes re-staged."
exit 0
